name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: >-
          Version to release (e.g. 1.2.3) â€” used when
          triggering manually without a git tag
        required: false
      skip-npm:
        description: Skip npm publish (e.g. already published)
        type: boolean
        default: false

jobs:
  npm:
    name: Publish to npm
    if: ${{ !inputs.skip-npm }}
    uses: codefuturist/shared-workflows/.github/workflows/release-npm.yml@v1
    permissions:
      contents: read
      id-token: write
    with:
      node-version: "24"
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  mcp:
    name: Publish to MCP Registry
    runs-on: ubuntu-latest
    needs: [npm]
    if: always() && (needs.npm.result == 'success' || needs.npm.result == 'skipped')

    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v6

      - name: Install mcp-publisher
        run: |
          OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
          ARCH="$(uname -m)"
          ARCH="${ARCH/x86_64/amd64}"
          ARCH="${ARCH/aarch64/arm64}"
          BASE="https://github.com/modelcontextprotocol"
          BASE="${BASE}/registry/releases/latest/download"
          curl -L \
            "${BASE}/mcp-publisher_${OS}_${ARCH}.tar.gz" \
            | tar xz mcp-publisher

      - name: Set version in server.json
        run: |
          VERSION="${{ inputs.version || '' }}"
          if [[ -z "$VERSION" ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          jq --arg v "$VERSION" '
            .version = $v
            | .packages[0].version = $v
          ' server.json > server.tmp && mv server.tmp server.json

      - name: Authenticate to MCP Registry
        run: ./mcp-publisher login github-oidc

      - name: Publish to MCP Registry
        run: ./mcp-publisher publish

  docker:
    name: Publish Docker Images
    runs-on: ubuntu-latest
    needs: [npm, mcp]
    if: always() && (needs.npm.result == 'success' || needs.npm.result == 'skipped') && needs.mcp.result == 'success'

    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Docker setup
        uses: codefuturist/shared-workflows/actions/docker-setup@v1
        with:
          ghcr-username: ${{ github.actor }}
          ghcr-token: ${{ secrets.GITHUB_TOKEN }}
          dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v7
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
